<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriPal AI Chatbot - Your Agricultural Assistant</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #chatbot-page {
            position: relative;
            isolation: isolate;
        }

        #chatbot-page::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1592982537447-6f2a6b0013e0?w=1920&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0.10;
            z-index: -1;
        }

        #chatbot-page::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.78), rgba(255,255,255,0.55));
            z-index: -1;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .chat-messages {
            height: 560px;
            overflow-y: auto;
            scroll-behavior: smooth;
            background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
        }

        .chat-messages::-webkit-scrollbar { width: 4px; }
        .chat-messages::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 2px; }

        .message { animation: fadeInUp 0.3s ease; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            max-width: 80%;
            padding: 14px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 14px 18px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            margin-bottom: 16px;
            max-width: 80%;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
        }

        .typing-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #16a34a;
            animation: typingDot 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40%           { transform: scale(1); opacity: 1; }
        }

        .status-indicator {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34,197,94,0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.55; }
        }

        .quick-action { transition: all 0.25s ease; }
        .quick-action:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(22,163,74,0.18); }

        .header-icon { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50%       { transform: translateY(-8px); }
        }

        .back-btn { transition: all 0.25s ease; }
        .back-btn:hover { background-color: rgba(255,255,255,0.2); transform: translateX(-3px); }

        /* Sidebar topic buttons */
        .topic-btn {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; border-radius: 10px; border: none;
            background: transparent; cursor: pointer;
            color: rgba(255,255,255,0.55);
            font-size: 13.5px; text-align: left;
            transition: all .18s; width: 100%;
        }
        .topic-btn .ic { font-size: 16px; min-width: 22px; text-align: center; transition: transform .2s; }
        .topic-btn:hover { background: rgba(126,200,58,0.15); color: #7ec83a; }
        .topic-btn:hover .ic { transform: scale(1.15); }

        /* Bot message formatting */
        .message.bot .message-content strong { color: #2e7d32; }
        .message.bot .message-content ul, .message.bot .message-content ol { padding-left: 18px; margin: 6px 0; }
        .message.bot .message-content li { margin: 4px 0; }
        .message.bot .message-content h3 { color: #2e7d32; margin: 8px 0 4px; font-weight: 700; }
        .message.bot .message-content code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Navbar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <i class="fas fa-leaf text-green-600 text-2xl header-icon"></i>
                    <span class="text-2xl font-bold text-gray-800">Agri<span class="text-green-600">Pal</span></span>
                </div>
                <div class="flex gap-4">
                    <a href="/" class="text-gray-600 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-home mr-2"></i>Home
                    </a>
                    <a href="/detection-tool" class="text-gray-600 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-microscope mr-2"></i>Detection
                    </a>
                    <a href="/post-harvest" class="text-gray-600 hover:text-green-600 transition-colors px-3 py-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-warehouse mr-2"></i>Post-Harvest
                    </a>
                    <a href="/chatbot" class="text-green-600 font-semibold px-3 py-2 rounded-lg bg-green-50">
                        <i class="fas fa-comments mr-2"></i>AI Chatbot
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Page -->
    <div id="chatbot-page" class="min-h-screen">

        <!-- Hero Header -->
        <div class="bg-gradient-to-r from-green-700 via-green-600 to-green-700 text-white py-12 relative">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="window.history.back()" class="flex items-center text-white px-4 py-2 rounded-lg back-btn">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                    <div class="flex items-center gap-3">
                        <span class="text-green-100 text-sm" id="systemInfo">AI Status: Online</span>
                        <div class="status-indicator" id="statusIndicator"></div>
                    </div>
                </div>
                <div class="text-center">
                    <i class="fas fa-seedling text-5xl mb-3 header-icon"></i>
                    <h1 class="text-3xl font-bold mb-1">AgriPal AI Assistant</h1>
                    <p class="text-green-100 text-base">Smart Farming ¬∑ Market Prices ¬∑ Schemes ¬∑ Pest Control</p>
                </div>
            </div>
        </div>

        <!-- Chat Layout -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex gap-6">

                <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ -->
                <div class="hidden lg:flex flex-col w-56 flex-shrink-0">
                    <div class="bg-gray-800 rounded-2xl p-4 shadow-xl flex flex-col gap-1 sticky top-24">

                        <div class="flex items-center gap-2 pb-3 mb-2 border-b border-white/10">
                            <div class="w-8 h-8 rounded-lg bg-green-700 flex items-center justify-center text-base">üå±</div>
                            <span class="text-white font-bold text-base">Quick Topics</span>
                        </div>

                        <button class="topic-btn" onclick="ask('What is the current price of rice in Karnataka?')">
                            <span class="ic">üìä</span> Market Prices
                        </button>
                        <button class="topic-btn" onclick="ask('Tell me about PM-KISAN scheme')">
                            <span class="ic">üèõÔ∏è</span> Govt. Schemes
                        </button>
                        <button class="topic-btn" onclick="ask('How to control pests in cotton crop?')">
                            <span class="ic">üêõ</span> Pest & Disease
                        </button>
                        <button class="topic-btn" onclick="ask('What is wheat production in Punjab?')">
                            <span class="ic">üåæ</span> Crop Production
                        </button>
                        <button class="topic-btn" onclick="ask('What is the weather and rainfall in Karnataka?')">
                            <span class="ic">üå¶Ô∏è</span> Weather Info
                        </button>
                        <button class="topic-btn" onclick="ask('Best farming practices for sugarcane?')">
                            <span class="ic">üí°</span> Best Practices
                        </button>
                        <button class="topic-btn" onclick="ask('What are organic pest control methods?')">
                            <span class="ic">üåø</span> Organic Farming
                        </button>
                        <button class="topic-btn" onclick="ask('What crops to plant in monsoon season?')">
                            <span class="ic">üóìÔ∏è</span> Seasonal Advice
                        </button>

                        <div class="mt-auto pt-4 border-t border-white/10 flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-green-400" style="box-shadow:0 0 6px rgba(74,222,128,0.6)"></div>
                            <span class="text-xs text-white/40">Assistant Online</span>
                        </div>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ Chat Panel ‚îÄ‚îÄ -->
                <div class="flex-1 min-w-0">
                    <div class="chat-container">

                        <!-- Chat header bar -->
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
                                        <i class="fas fa-seedling text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800">AgriPal AI</h3>
                                        <p class="text-xs text-gray-500">Prices ¬∑ Schemes ¬∑ Pest Control ¬∑ Production Data</p>
                                    </div>
                                </div>
                                <span class="bg-green-600 text-white text-xs font-semibold px-3 py-1 rounded-full flex items-center gap-1">
                                    <i class="fas fa-database text-xs"></i> Smart Assistant
                                </span>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div class="chat-messages p-6" id="chatMessages">
                            <!-- Welcome message -->
                            <div class="message bot">
                                <div class="message-content">
                                    <div class="font-bold text-green-700 mb-2">
                                        <i class="fas fa-leaf mr-2"></i>Namaste! Welcome to AgriPal AI! üëã
                                    </div>
                                    <div class="text-gray-700 mb-3">
                                        I'm your smart agricultural assistant. I can help you with:
                                    </div>
                                    <ul class="space-y-1 text-sm text-gray-700 mb-4">
                                        <li>üìä Current market prices for crops</li>
                                        <li>üèõÔ∏è Government schemes & subsidies (PM-KISAN, etc.)</li>
                                        <li>üêõ Pest & disease identification and treatment</li>
                                        <li>üåæ Crop production data and yield information</li>
                                        <li>üí° Best farming practices and seasonal advice</li>
                                    </ul>
                                    <div class="flex flex-wrap gap-2 mt-3">
                                        <button onclick="ask('Rice price in Karnataka today')" class="quick-action bg-green-100 text-green-700 px-3 py-1.5 rounded-full text-xs font-medium hover:bg-green-200">
                                            üåæ Rice prices
                                        </button>
                                        <button onclick="ask('Tell me about PM-KISAN scheme')" class="quick-action bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full text-xs font-medium hover:bg-blue-200">
                                            üèõÔ∏è PM-KISAN
                                        </button>
                                        <button onclick="ask('Cotton pest control methods')" class="quick-action bg-orange-100 text-orange-700 px-3 py-1.5 rounded-full text-xs font-medium hover:bg-orange-200">
                                            üêõ Pest control
                                        </button>
                                        <button onclick="ask('Wheat production in Punjab 2023')" class="quick-action bg-purple-100 text-purple-700 px-3 py-1.5 rounded-full text-xs font-medium hover:bg-purple-200">
                                            üìà Production data
                                        </button>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-3" id="welcomeTime"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Typing indicator -->
                        <div class="px-6">
                            <div class="typing-indicator" id="typingIndicator">
                                <div class="text-sm text-gray-500">üå± AgriPal is thinking...</div>
                                <div class="flex gap-1">
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Input area -->
                        <div class="p-5 bg-gray-50 border-t border-gray-200">
                            <div class="flex gap-3 items-center">
                                <input
                                    type="text"
                                    id="chatInput"
                                    class="flex-1 px-5 py-3 border-2 border-gray-200 rounded-full focus:border-green-500 focus:outline-none text-gray-800 text-sm"
                                    placeholder="Ask about crops, prices, schemes, pests‚Ä¶"
                                    onkeypress="handleKeyPress(event)"
                                >
                                <button
                                    id="voiceButton"
                                    onclick="toggleVoiceInput()"
                                    class="w-11 h-11 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center transition-all"
                                    title="Voice Input"
                                >
                                    <i class="fas fa-microphone text-sm"></i>
                                </button>
                                <button
                                    id="sendButton"
                                    onclick="sendMessage()"
                                    class="w-11 h-11 bg-green-600 hover:bg-green-700 text-white rounded-full flex items-center justify-center transition-all"
                                    title="Send"
                                >
                                    <i class="fas fa-paper-plane text-sm"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 text-center mt-2">Press Enter to send &nbsp;¬∑&nbsp; Ask in English or Hindi crop names</p>
                        </div>
                    </div>

                    <!-- Info cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mt-6">
                        <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
                            <div class="w-11 h-11 bg-green-100 rounded-full flex items-center justify-center mb-3">
                                <i class="fas fa-database text-green-600"></i>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Live Database</h3>
                            <p class="text-xs text-gray-500">Market prices, government schemes, and crop production data pulled from verified sources.</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
                            <div class="w-11 h-11 bg-blue-100 rounded-full flex items-center justify-center mb-3">
                                <i class="fas fa-shield-alt text-blue-600"></i>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">Reliable Data</h3>
                            <p class="text-xs text-gray-500">Information from government databases, research papers, and verified agricultural experts.</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
                            <div class="w-11 h-11 bg-purple-100 rounded-full flex items-center justify-center mb-3">
                                <i class="fas fa-clock text-purple-600"></i>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-1">24/7 Available</h3>
                            <p class="text-xs text-gray-500">Get instant answers to your agricultural questions anytime, anywhere.</p>
                        </div>
                    </div>
                </div>
                <!-- end chat panel -->

            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let isListening = false;
        let recognition = null;

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('chatInput').focus();
            document.getElementById('welcomeTime').textContent = new Date().toLocaleTimeString();
            setupVoiceRecognition();
        });

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function ask(text) {
            document.getElementById('chatInput').value = text;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            const sendBtn = document.getElementById('sendButton');
            sendBtn.disabled = true;

            addMessage('user', message);
            conversationHistory.push({ role: 'user', text: message });
            showTyping();

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: message })
                });
                const data = await res.json();
                hideTyping();

                const reply = data.answer || "Sorry, I couldn't find information for that. Please try rephrasing your question.";
                addMessage('bot', reply);

                conversationHistory.push({ role: 'bot', text: reply });

            } catch (err) {
                hideTyping();
                addMessage('bot',
                    '‚ö†Ô∏è Connection error. Please check that the server is running.\n\n' +
                    'You can also try:\n‚Ä¢ Refreshing the page\n‚Ä¢ Asking a different question');
            } finally {
                sendBtn.disabled = false;
                input.focus();
            }
        }

        function addMessage(sender, content) {
            const container = document.getElementById('chatMessages');
            const row = document.createElement('div');
            row.className = `message ${sender} mb-4 flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-content';

            if (sender === 'bot') {
                bubble.innerHTML = formatBotMessage(content);
            } else {
                bubble.textContent = content;
            }

            const time = document.createElement('div');
            time.className = 'text-xs mt-2 opacity-60 text-right';
            time.textContent = new Date().toLocaleTimeString();
            bubble.appendChild(time);

            row.appendChild(bubble);
            container.appendChild(row);
            container.scrollTop = container.scrollHeight;
        }

        function formatBotMessage(text) {
            return text
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h3>$1</h3>')
                .replace(/\n/g, '<br>');
        }

        function showTyping() {
            const t = document.getElementById('typingIndicator');
            t.style.display = 'flex';
            document.getElementById('chatMessages').scrollTop = 99999;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function setupVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SR();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-IN';

                recognition.onstart = () => {
                    isListening = true;
                    const btn = document.getElementById('voiceButton');
                    btn.innerHTML = '<i class="fas fa-stop text-sm"></i>';
                    btn.classList.replace('bg-blue-600', 'bg-red-600');
                };
                recognition.onend = () => {
                    isListening = false;
                    const btn = document.getElementById('voiceButton');
                    btn.innerHTML = '<i class="fas fa-microphone text-sm"></i>';
                    btn.classList.replace('bg-red-600', 'bg-blue-600');
                };
                recognition.onresult = (e) => {
                    document.getElementById('chatInput').value = e.results[0][0].transcript;
                    sendMessage();
                };
                recognition.onerror = (e) => console.error('Voice error:', e.error);
            } else {
                document.getElementById('voiceButton').style.display = 'none';
            }
        }

        function toggleVoiceInput() {
            if (!recognition) return;
            if (isListening) recognition.stop();
            else recognition.start();
        }
    </script>
</body>
</html>